# FineReport 自动化打印工具 - 实现计划

## 1. 项目概述

### 1.1 项目名称
FineReport Auto Print Tool（FineReport 自动化打印工具）

### 1.2 项目目标
开发一个轻量级客户端应用，自动打开 FineReport 报表页面并执行打印操作，将医疗处方单打印到指定的 HP 激光打印机。

### 1.3 核心功能
- 自动打开指定的 FineReport 报表 URL
- 等待页面完全加载（等待 FR 对象可用）
- 自动执行 `FR.doURLPrint()` 函数
- 支持自定义打印参数（打印机名称、报表数据等）
- 提供简洁的用户界面（可选）

## 2. 技术选型

### 2.1 框架选择：Wails v2
**理由：**
- 安装包体积小（约 10MB，相比 Electron 的 50-80MB）
- 性能优秀，使用系统 WebView，不内嵌浏览器
- Go 语言后端，执行效率高
- 跨平台支持（Windows、macOS、Linux）

### 2.2 技术栈
- **后端：** Go 1.21+
- **前端：** HTML + JavaScript + CSS（使用原生 WebView）
- **框架：** Wails v2
- **UI 库：** 原生 HTML/CSS（轻量级，可选 Naive UI）

### 2.3 依赖项
- `github.com/wailsapp/wails/v2` - Wails 框架
- `github.com/wailsapp/go-webview2` - WebView2 支持（Windows）

## 3. 项目结构

```
fine-report-printer/
├── app.go                 # 主应用入口
├── main.go               # 程序入口
├── internal/
│   ├── printer/
│   │   └── printer.go    # 打印逻辑封装
│   └── config/
│       └── config.go     # 配置管理
├── frontend/
│   ├── index.html        # 前端页面（可选，用于配置界面）
│   ├── app.js            # 前端逻辑
│   └── style.css         # 样式文件
├── build/
│   └── ...               # 构建输出
├── go.mod
├── go.sum
├── wails.json            # Wails 配置文件
└── README.md
```

## 4. 功能设计

### 4.1 核心打印参数结构

```go
type PrintParams struct {
    PrintURL    string   `json:"printUrl"`
    PrintType   int      `json:"printType"`
    PageType    int      `json:"pageType"`
    IsPopUp     bool     `json:"isPopUp"`
    PrinterName string   `json:"printerName"`
    Data        PrintData `json:"data"`
}

type PrintData struct {
    Reportlets []Reportlet `json:"reportlets"`
}

type Reportlet struct {
    Reportlet      string `json:"reportlet"`
    IdMedpers      string `json:"idMedpers"`
    OrgNa          string `json:"orgNa"`
    IdVismed       string `json:"idVismed"`
    DocumentNumber string `json:"documentNumber"`
}
```

### 4.2 打印 URL 配置

**基础 URL：**
```
http://172.20.38.62:8080/webroot/decision/view/report?viewlet=hi%252Fhis%252FhiOpDoc%252Fguidance%252FMedpers_mzys.cpt&ref_t=design&ref_c=baa2e03a-c410-46b9-b92a-b2b25ff2
```

### 4.3 默认打印参数

```json
{
    "printUrl": "http://172.20.38.62:8080/webroot/decision/view/report",
    "printType": 1,
    "pageType": 0,
    "isPopUp": false,
    "printerName": "HP LaserJet Pro P1100 plus series",
    "data": {
        "reportlets": [
            {
                "reportlet": "hi/his/hiOpDoc/guidance/Medpers_mzys.cpt",
                "idMedpers": "672315903281201152",
                "orgNa": "南方医科大学口腔医院",
                "idVismed": "763843129987043328",
                "documentNumber": "20251218000001"
            }
        ]
    }
}
```

## 5. 实现步骤

### 阶段 1：项目初始化

#### 步骤 1.1：环境准备
- [ ] 安装 Go 1.21 或更高版本
- [ ] 安装 Wails CLI：`go install github.com/wailsapp/wails/v2/cmd/wails@latest`
- [ ] 验证 Wails 安装：`wails version`
- [ ] （Windows）确保系统已安装 WebView2 Runtime

#### 步骤 1.2：创建项目
- [ ] 使用 Wails 创建新项目：`wails init -n fine-report-printer -t vanilla`
- [ ] 初始化 Go modules
- [ ] 配置 `wails.json`

### 阶段 2：核心功能实现

#### 步骤 2.1：定义数据结构
- [ ] 在 `internal/printer/printer.go` 中定义打印参数结构体
- [ ] 定义打印配置结构

#### 步骤 2.2：实现打印逻辑
- [ ] 创建 `Print()` 方法，负责：
  - 打开指定 URL
  - 等待页面加载完成
  - 检测 FR 对象是否可用
  - 执行 `FR.doURLPrint()` JavaScript 函数
  - 处理错误和超时

#### 步骤 2.3：JavaScript 注入逻辑
```javascript
// 等待 FR 对象加载
function waitForFR(maxAttempts = 50, interval = 200) {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const checkFR = setInterval(() => {
            attempts++;
            if (window.FR && typeof window.FR.doURLPrint === 'function') {
                clearInterval(checkFR);
                resolve(window.FR);
            } else if (attempts >= maxAttempts) {
                clearInterval(checkFR);
                reject(new Error('FR object not found after timeout'));
            }
        }, interval);
    });
}

// 执行打印
async function executePrint(printParams) {
    try {
        await waitForFR();
        window.FR.doURLPrint(printParams);
        return { success: true };
    } catch (error) {
        return { success: false, error: error.message };
    }
}
```

#### 步骤 2.4：Go 后端调用
- [ ] 在 `app.go` 中实现前端绑定的方法
- [ ] 使用 Wails 的 `webview` API 执行 JavaScript
- [ ] 处理 JavaScript 执行结果

### 阶段 3：用户界面（可选）

#### 步骤 3.1：创建配置界面
- [ ] 设计简单的 HTML 界面
- [ ] 允许用户修改打印参数
- [ ] 添加"执行打印"按钮
- [ ] 显示打印状态（成功/失败）

#### 步骤 3.2：实现前端交互
- [ ] 使用 Wails 的前后端通信机制
- [ ] 调用后端打印方法
- [ ] 显示反馈信息

### 阶段 4：配置管理

#### 步骤 4.1：配置文件
- [ ] 支持 JSON 配置文件
- [ ] 可配置打印参数
- [ ] 可配置超时时间、重试次数等

#### 步骤 4.2：默认配置
- [ ] 提供默认配置文件
- [ ] 首次运行时创建配置文件

### 阶段 5：错误处理和日志

#### 步骤 5.1：错误处理
- [ ] 处理网络连接错误
- [ ] 处理页面加载超时
- [ ] 处理 FR 对象未找到的情况
- [ ] 处理打印机未找到的情况

#### 步骤 5.2：日志系统
- [ ] 实现日志记录功能
- [ ] 记录打印操作日志
- [ ] 记录错误信息

### 阶段 6：测试

#### 步骤 6.1：单元测试
- [ ] 测试数据结构序列化/反序列化
- [ ] 测试配置加载

#### 步骤 6.2：集成测试
- [ ] 测试完整打印流程
- [ ] 测试错误场景
- [ ] 测试不同打印机名称

### 阶段 7：打包和发布

#### 步骤 7.1：构建应用
- [ ] 使用 `wails build` 构建应用
- [ ] 测试打包后的可执行文件
- [ ] 优化构建配置

#### 步骤 7.2：创建安装包（可选）
- [ ] 配置 Windows 安装程序
- [ ] 添加应用图标
- [ ] 配置版本信息

## 6. 关键技术点

### 6.1 等待 FR 对象加载
**挑战：** FineReport 页面加载后，FR 对象可能不是立即可用
**解决方案：** 
- 使用 JavaScript 轮询检测 `window.FR` 是否存在
- 设置最大等待时间和重试次数
- 使用 Promise 封装异步等待逻辑

### 6.2 执行 JavaScript
**Wails 方式：**
```go
result, err := app.ctx.Run(ctx, "window.FR.doURLPrint(...)")
```

### 6.3 页面加载检测
**方案：** 
- 监听 WebView 的页面加载完成事件
- 使用 JavaScript 的 `window.addEventListener('load')`

### 6.4 错误处理策略
- 网络错误：显示友好提示，允许重试
- 超时错误：增加等待时间，多次重试
- FR 对象未找到：检查 URL 是否正确，页面是否正常加载

## 7. 开发时间估算

| 阶段 | 预计时间 | 说明 |
|------|---------|------|
| 项目初始化 | 0.5 天 | 环境搭建、项目创建 |
| 核心功能实现 | 2-3 天 | 打印逻辑、JavaScript 注入 |
| 用户界面 | 1-2 天 | HTML 界面、交互逻辑 |
| 配置管理 | 0.5 天 | 配置文件读写 |
| 错误处理和日志 | 1 天 | 完善错误处理 |
| 测试 | 1-2 天 | 功能测试、问题修复 |
| 打包发布 | 0.5 天 | 构建优化、打包 |
| **总计** | **6.5-9.5 天** | 约 1-2 周 |

## 8. 后续扩展功能（可选）

### 8.1 批量打印
- 支持读取 CSV/Excel 文件
- 批量处理多个处方单

### 8.2 打印历史
- 记录打印历史
- 支持查看和重打

### 8.3 多打印机支持
- 打印机列表选择
- 默认打印机配置

### 8.4 命令行支持
- 支持命令行参数
- 适合自动化脚本调用

## 9. 注意事项

### 9.1 安全性
- 硬编码的 URL 和参数需要考虑安全性
- 敏感信息建议使用配置文件或环境变量

### 9.2 兼容性
- 确保 WebView2 Runtime 已安装
- 测试不同 Windows 版本的兼容性

### 9.3 性能
- 页面加载超时时间设置合理
- 避免无限等待导致程序卡死

### 9.4 用户体验
- 提供清晰的状态提示
- 错误信息要友好易懂

## 10. 参考资料

- [Wails 官方文档](https://wails.io/docs/)
- [FineReport JavaScript API](http://help.fanruan.com/finereport/)
- [WebView2 文档](https://learn.microsoft.com/zh-cn/microsoft-edge/webview2/)
- [Tiny RDM GitHub](https://github.com/tiny-craft/tiny-rdm) - 参考实现

---

**文档版本：** v1.0  
**创建日期：** 2025-01-20  
**最后更新：** 2025-01-20


